#!/usr/bin/env bash
set -euo pipefail

ZERO_SHA="0000000000000000000000000000000000000000"
HOOK_MODE="${G_AGENT_PRE_PUSH_MODE:-quick}"

if [[ "${G_AGENT_SKIP_PRE_PUSH:-0}" == "1" ]]; then
  echo "g-agent pre-push: skipped (G_AGENT_SKIP_PRE_PUSH=1)"
  exit 0
fi

case "$HOOK_MODE" in
  quick|full|changed) ;;
  *)
    echo "g-agent pre-push: invalid mode '$HOOK_MODE' (use quick|full|changed)"
    exit 1
    ;;
esac

if ! repo_root="$(git rev-parse --show-toplevel 2>/dev/null)"; then
  echo "g-agent pre-push: unable to detect repository root"
  exit 1
fi
cd "$repo_root"

run_cmd() {
  echo "g-agent pre-push: $*"
  "$@"
}

run_python_tool() {
  local tool="$1"
  shift

  if command -v "$tool" >/dev/null 2>&1; then
    run_cmd "$tool" "$@"
    return
  fi

  if python -m "$tool" --version >/dev/null 2>&1; then
    run_cmd python -m "$tool" "$@"
    return
  fi

  if command -v pipx >/dev/null 2>&1; then
    echo "g-agent pre-push: '$tool' not found, using pipx fallback"
    run_cmd pipx run --spec "$tool" "$tool" "$@"
    return
  fi

  echo "g-agent pre-push: missing '$tool'. Install backend dev deps: pip install -e \"backend/agent[dev]\""
  return 1
}

target_main=false
need_backend=false
need_landing=false
backend_force_quick=false
backend_changed_py=()
backend_changed_tests=()
landing_changed=false

while read -r local_ref local_sha remote_ref remote_sha; do
  [[ "$local_ref" == "refs/heads/main" ]] || continue
  target_main=true

  changed_files=""
  if [[ "$remote_sha" == "$ZERO_SHA" ]]; then
    changed_files="$(git diff-tree --no-commit-id --name-only -r "$local_sha" || true)"
  else
    changed_files="$(git diff --name-only "$remote_sha" "$local_sha" || true)"
  fi

  if [[ -z "$changed_files" ]]; then
    changed_files="$(git diff --name-only HEAD~1 HEAD || true)"
  fi

  while IFS= read -r path; do
    [[ -n "$path" ]] || continue
    case "$path" in
      backend/*|.github/workflows/*|docs/*|README.md|CHANGELOG.md)
        need_backend=true
        ;;
    esac
    case "$path" in
      landingpages/*|.github/workflows/*|README.md|CHANGELOG.md)
        need_landing=true
        ;;
    esac
    if [[ "$path" == backend/agent/* ]]; then
      if [[ "$path" == *.py ]]; then
        rel_path="${path#backend/agent/}"
        backend_changed_py+=("$rel_path")
        if [[ "$rel_path" == tests/test_*.py ]]; then
          backend_changed_tests+=("$rel_path")
        fi
      fi
      case "$path" in
        backend/agent/pyproject.toml|backend/agent/requirements*.txt)
          backend_force_quick=true
          ;;
      esac
    fi
    if [[ "$path" == landingpages/* ]]; then
      landing_changed=true
    fi
  done <<< "$changed_files"
done

if [[ "$target_main" != true ]]; then
  echo "g-agent pre-push: non-main branch, no guard checks required"
  exit 0
fi

if [[ "$need_backend" != true && "$need_landing" != true ]]; then
  need_backend=true
  need_landing=true
fi

if [[ "${G_AGENT_HOOK_TEST_MODE:-0}" == "1" ]]; then
  echo "g-agent pre-push test-mode: mode=$HOOK_MODE main=$target_main backend=$need_backend landing=$need_landing backend_py=${#backend_changed_py[@]} backend_tests=${#backend_changed_tests[@]} landing_changed=$landing_changed"
  exit 0
fi

echo "g-agent pre-push: guarding push to main (mode=$HOOK_MODE)"

if [[ "$need_backend" == true ]]; then
  echo "g-agent pre-push: running backend checks"
  (
    cd backend/agent
    if [[ "$HOOK_MODE" == "changed" && ${#backend_changed_py[@]} -eq 0 && "$backend_force_quick" != "true" ]]; then
      echo "g-agent pre-push: no backend python/runtime changes detected, skipping backend checks"
      exit 0
    fi
    run_cmd python -m compileall -q g_agent
    if [[ "$HOOK_MODE" == "changed" && ${#backend_changed_py[@]} -gt 0 ]]; then
      run_python_tool ruff check --select F "${backend_changed_py[@]}"
    else
      run_python_tool ruff check g_agent tests --select F
    fi
    if [[ "$HOOK_MODE" == "quick" || "$HOOK_MODE" == "changed" ]]; then
      if [[ "$HOOK_MODE" == "changed" && ${#backend_changed_tests[@]} -gt 0 ]]; then
        PYTHONPATH="$PWD" run_python_tool pytest -q "${backend_changed_tests[@]}"
      else
        PYTHONPATH="$PWD" run_python_tool pytest -q \
          tests/test_security_audit.py \
          tests/test_security_fix.py \
          tests/test_metrics_retention_alerts.py \
          tests/test_metrics_http_server.py
      fi
    else
      PYTHONPATH="$PWD" run_python_tool pytest -q
    fi
  )
fi

if [[ "$need_landing" == true ]]; then
  echo "g-agent pre-push: running landingpages checks"
  (
    if [[ "$HOOK_MODE" == "changed" && "$landing_changed" != "true" ]]; then
      echo "g-agent pre-push: no landingpages changes detected, skipping landing checks"
      exit 0
    fi
    cd landingpages
    if ! command -v npm >/dev/null 2>&1; then
      echo "g-agent pre-push: missing 'npm' in PATH"
      exit 1
    fi
    if [[ ! -d node_modules ]]; then
      echo "g-agent pre-push: landingpages/node_modules not found. Run: cd landingpages && npm ci"
      exit 1
    fi
    run_cmd npm run lint
    run_cmd npm run typecheck
    if [[ "$HOOK_MODE" == "full" ]]; then
      run_cmd npm run build
    fi
  )
fi

echo "g-agent pre-push: all required checks passed"
